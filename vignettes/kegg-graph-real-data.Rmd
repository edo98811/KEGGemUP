---
title: "kegg-graph"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{kegg-graph}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library("KEGGemUP")
```

```{r load-fake-results}
message("--- Loading packages...")

suppressPackageStartupMessages({
  library("macrophage")
  library("DESeq2")
  library("org.Hs.eg.db")
  library("AnnotationDbi")
  library("clusterProfiler")
  library("limma")
  library("edgeR")
})
message("- Done!")

# Load the macrophage dataset ---------------------------------------------------
data(gse)
rownames(gse) <- substr(rownames(gse), 1, 15)  # truncate rownames at 15 characters

# DESeq2 analysis ---------------------------------------------------------------
dds <- DESeqDataSet(gse, design = ~ condition)

# Filter low counts
keep <- rowSums(counts(dds) >= 10) >= 6
dds <- dds[keep, ]

dds <- DESeq(dds)

# limma analysis ---------------------------------------------------------------
condition <- factor(colData(gse)[, "condition_name"])
design <- model.matrix(~0 + condition)

contrast.matrix <- makeContrasts(
  IFNg_vs_naive = conditionIFNg - conditionnaive,
  levels = design
)

dge <- DGEList(assay(gse))
dge <- calcNormFactors(dge)

cutoff <- 1
drop <- which(apply(cpm(dge), 1, max) < cutoff)
dge <- dge[-drop, ]

voom_mat <- voom(dge, design, plot = FALSE)
fit <- lmFit(voom_mat, design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)  # Empirical Bayes moderation

# Gene annotation ---------------------------------------------------------------

anns <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys = rownames(dds),
  columns = c("SYMBOL", "ENTREZID"),
  keytype = "ENSEMBL",
  multiVals = "first"
)

# DESeq2 results ---------------------------------------------------------------
res_macrophage_IFNg_vs_naive_dds <- results(
  dds,
  contrast = c("condition", "IFNg", "naive"),
  lfcThreshold = 1,
  alpha = 0.05
)

summary(res_macrophage_IFNg_vs_naive_dds) 

res_macrophage_IFNg_vs_naive_dds$SYMBOL <- rowData(dds)$SYMBOL
res_macrophage_IFNg_vs_naive_dds$ENTREZID <- anns$ENTREZID[match(rownames(res_macrophage_IFNg_vs_naive_dds), anns$ENSEMBL)]

# limma results ---------------------------------------------------------------
res_macrophage_IFNg_vs_naive_limma <- topTable(
  fit2,
  coef = "IFNg_vs_naive",
  adjust = "fdr",
  number = Inf,
  confint = TRUE
)

res_macrophage_IFNg_vs_naive_limma$ENTREZID <- anns$ENTREZID[match(rownames(res_macrophage_IFNg_vs_naive_limma), anns$ENSEMBL)]

# Enrichment analysis ----------------------------------------------------------
de_entrez_IFNg_vs_naive_genes <- anns $ENTREZID[
  (!is.na(res_macrophage_IFNg_vs_naive_dds$padj)) &
    (res_macrophage_IFNg_vs_naive_dds$padj <= 0.05)
]

res_enrich_IFNg_vs_naive_dds <- enrichKEGG(
  gene = de_entrez_IFNg_vs_naive_genes,
  organism = "hsa",
  pvalueCutoff = 0.05
)@result

```
## Functions to parse KGML files

You can use these functions to parse KGML files directly. From these you can build a graph object if you wish to do so.
```{r kgml-parsing}
nodes_df <- parse_kgml_entries(system.file("extdata", "hsa04010.xml", package = "KEGGemUP"))
edges_df <- parse_kgml_relations(system.file("extdata", "hsa04010.xml", package = "KEGGemUP"))
```

### The output tibble frame for nodes
```{r}
knitr::kable(head(nodes_df))
```

### The output tibble frame for edges

```{r}
knitr::kable(head(edges_df))
```

## Build a graph from a pathway ID and map results to nodes

You can build a graph object from a KEGG pathway ID and map your differential expression results to the nodes of the graph.
To do so, you can provide a list of differentially expressed results tables, each with the following structure:

- de_table: a data.frame with the differential expression results
- value_column: the name of the column in de_table containing the values to map to the nodes
- feature_column: the name of the column in de_table containing the feature IDs (e.g., ENTREZ IDs) that correspond to the KEGG ids in the graph (without organism prefix).

```{r}
de_results_list <-list(
  trans_limma = list(
    de_table = data.frame(res_macrophage_IFNg_vs_naive_limma),
    value_column = "logFC",
    feature_column = "ENTREZID"
  ),
  trans_deseq = list(
    de_table = data.frame(res_macrophage_IFNg_vs_naive_dds),
    value_column = "log2FoldChange",
    feature_column = "ENTREZID"
    )
)
```

You can also provide a single differential expression results table as a data.frame. For that the column names need to respect the default values:
- "KEGG_ids": the column containing the KEGG feature IDs (without organism prefix)
- "log2FoldChange": the column containing the values to map to the nodes
```{r}
de_results_limma <-  data.frame(res_macrophage_IFNg_vs_naive_limma)[res_macrophage_IFNg_vs_naive_limma$adj.P.Val < 0.05, ]
de_results_limma$log2FoldChange <- de_results_limma$logFC
de_results_limma$KEGG_ids <- de_results_limma$ENTREZID
```

### Example of usage
```{r use-package}
pathway <- rownames(res_enrich_IFNg_vs_naive_dds)[6]
graph <- kegg_to_graph(pathway)
graph <- map_results_to_nodes(graph, de_results_list)
graph
```

```{r use-package-2}
graph <- kegg_to_graph(pathway)
graph <- map_results_to_nodes(graph, de_results_limma)
graph
```

